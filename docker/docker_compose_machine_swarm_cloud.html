<!DOCTYPE html>
<html>
<head>
   <title>Docker with Compose, Machine and Swarm,  easy steps from localhost to cloud providers</title>
   <link rel="shortcut icon" href="/favicon.ico" />
   <meta name="keyword" content="docker,container,virtualization,compose,fig,engine,swarm,machine,cluster,cloud,aws,amazon,google,digitalocean"/>
   <meta name="description" content="Docker with Compose, Machine and Swarm, easy steps from localhost to cloud providers. Orchestrate applications, create VMs, cluster and scale, on AWS EC2 and Google Compute Engine and others"/>
   <meta name="viewport" content="initial-scale=0.8"/>
   <link href="docs.css" rel="stylesheet" type="text/css" />
   <link href="../android/docs.css" rel="stylesheet" type="text/css" />
   <style>
    #ship {
      min-width: 20em;
      max-width: 50em;
    }
    #starboard {
      width: 9em;
    }
    p {
      font-size: 0.85em;
    }
    code.wide {
      max-width: 65em;
    }
    code {
      font-size: 0.8em;
    }
    code.tiny {
      font-size: 0.6em;
    }
    code.output {
      background-color: #36a;
    }
    code a,code a:visited { 
      color: white; 
    }
   </style>
   <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-281408-1']);
    _gaq.push(['_trackPageview']);

     (function() {
     if(location.host!='localhost'){
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    }
    })();
  </script>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>

   <div id="ocean">
      <div id="ship">
         <div id="toprighter">
            <a href="http://creativecommons.org/licenses/by-sa/2.5/"><img
               src="/images/cc-by-sa-small.png" alt="cc by-sa"
               title="Creative Commons Attributions-ShareAlike"
               border="0" align="right" /></a>
            <a href="http://flurdy.com"><img src="/images/flurdy_warped_dual_small.png" border="0" align="right" alt="flurdy" title="" class="flurdySmall"/></a>
         </div>
         <header>
            <h1>
              Docker with Compose, Machine and Swarm, 
              easy steps from localhost to cloud providers
            </h1>
            <h3>
              Orchestrate applications, 
              create VMs,
              cluster and scale, 
              on AWS EC2 and Google Compute Engine and others</h3>
         </header>
         <nav id="lookout">
            <ul class="horizontal">
               <li><a href="http://flurdy.com">flurdy</a></li>
               <li><a href="http://twitter.com/flurdy">@flurdy</a></li>
               <li><a href="http://blog.flurdy.com">blog</a></li>
               <li><a href="http://shirts.flurdy.com">shirts</a></li>
               <li><a href="http://www.eray.uk">hire</a></li>
               <li><a href="/docs/">more docs</a></li>
            </ul>
         </nav>
         <div id="jib">
            Started: March 2015.
            Last updated: 15th May 2015.
         </div>

    <!-- flurdy docker compose leaderboard -->
    <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-7805345644641760"
      data-ad-slot="4707854483"
      data-ad-format="auto"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

      <div id="starboard">
        <nav>
               <h5>Contents</h5>
               <ul>
                  <li><a href="#why">Why</a></li>
                  <li>
                    <a href="#what">What</a>
                    <ul>
                      <li><a href="#what_docker_engine">Docker Engine</a></li>
                      <li><a href="#what_docker_compose">Docker Compose</a></li>
                      <li><a href="#what_docker_machine">Docker Machine</a></li>
                      <li><a href="#what_docker_swarm">Docker Swarm</a></li>
                    </ul>
                  </li>
                  <li>
                    <a href="#setup">Setup</a>
                    <ul>
                      <li><a href="#setup_docker_engine">Install Docker</a></li>
                      <li><a href="#setup_docker_compose">Install Compose</a></li>
                      <li><a href="#setup_docker_machine">Install Machine</a></li>
                      <li><a href="#setup_docker_swarm">Install Swarm</a></li>
                    </ul>
                  </li>
                  <li><a href="#orchestrate">Orchestrate</a></li>
                  <li>
                    <a href="#generate_cloud">Create Clouds</a>
                    <ul>
                      <li><a href="#cloud_google">Google Compute Engine</a></li>
                      <li><a href="#cloud_aws">Amazon AWS EC2</a></li>
                      <li><a href="#cloud_digitalocean">Digital Ocean</a></li>
                      <li><a href="#cloud_other">Other providers</a></li>
                      <li><a href="#cloud_stop">Stop and remove cloud machines</a></li>                      
                    </ul>
                  </li>
                  <li><a href="#push_cloud">Push to the cloud</a></li>
                  <li>
                    <a href="#scale_cloud">Scale the Cloud</a>
                    <ul>
                      <li><a href="#swarm_local">Swarm locally</a></li>
                      <li><a href="#swarm_cloud">Swarm in the cloud</a></li>
                    </ul>
                  </li>
                  <li><a href="#summary">Summary</a></li>
                  <li><a href="#future">Future</a></li>
                  <li><a href="#alternative">Alternatives</a></li>
                  <li><a href="#reference">References</a></li>
                  <li><a href="#contact">Feedback</a></li>
               </ul>
        </nav>
            <div class="shirts">
               <div class="shirt">
                  <a href="http://flurdy.spreadshirt.com/no-i-will-not-fix-your-computer-A3797075/customize/color/2"><img id="wontfix"
                     src="http://image.spreadshirt.com/image-server/v1/products/110865579/views/1,width=280,height=280.png/no-i-will-not-fix-your-computer-1850.png"
                     asrc="http://image.spreadshirt.com/image-server/v1/compositions/3938270/views/1,width=280,height=280,appearanceId=70.png/no-i-will-not-fix-your-computer_design.png" asrc="http://image.spreadshirt.com/image-server/v1/products/4169056/views/1,width=280,height=280.png/no-i-will-not-fix-your-computer-351.png" ssrc="http://image.spreadshirt.com/image-server/v1/compositions/4169056/views/1,width=280,height=280,appearanceId=2.png/no-i-will-not-fix-your-computer_design.png" alt="wont fix" title="No, I will not fix your computer"/></a>
               </div>
               <div class="shirt">
                  <a href="http://flurdy.spreadshirt.com/i-see-dumb-people-A3764115/customize/color/2"><img class="dumb"
                     src="http://image.spreadshirt.com/image-server/v1/products/110889074/views/1,width=280,height=280.png/i-see-dumb-people-1850.png" asrc="http://image.spreadshirt.com/image-server/v1/compositions/110889074/views/1,width=280,height=280,appearanceId=2.png/i-see-dumb-people_design.png" alt="I see dumb people" title="I see dumb people"/></a>
               </div>
               <div class="link"><a href="http://shirts.flurdy.com">shirts.flurdy.com</a></div>
            </div>
      </div>
         <div id="cargo">

            <a name="why"></a>
            <h3>Why</h3>
            <p>
              Create reproducible architecture of application containers
              using Docker Engine, Docker Compose, Docker Machine and Docker Swarm.
            </p>
            <p>
              Easy steps to create and deploy your applications locally 
              and push to any cloud provider using the same toolset.
            </p>

            <a name="what"></a>
            <a name="what_docker_engine"></a>
            <h3>What</h3>
            <h4>Docker Engine</h4>
            <p>
              <a href="http://docker.com">Docker</a>, more specifically Docker Engine,
              is a popular framework to run applications in containers.
            </p>
            <p>
              It however only gives to the tools to manage one container at time.
              There is no way to associate containers with each other, 
              beyond basic linking for IP and port aliasing,
              and sharing folder volumes, nor ability to act on linked containers in one command.
            </p>
            <a name="what_docker_compose"></a>
            <h4>Docker Compose</h4>
            <p>
              <a href="http://fig.sh">Fig.sh</a> was a great solution to this as it is
              a tool to orchestrate multiple containers into one system architecture.
              E.g. you might have a database container, 
              a API based business application container
              and a front end application container. 
              You configure these as 3 containers, tell Fig how they connect and off you go.
            </p>
            <p>
              Fig and its creators at <a href="http://www.orchardup.com">Orchard</a> got swallowed up by Docker,
              and Docker has instead just released <a href="https://docs.docker.com/compose/">Docker Compose</a> as the tool to orchestrate containers to replace Fig <a href="https://twitter.com/aanand/status/570957006523277312">which is now deprecated</a>.
            </p>
            <a name="what_docker_machine"></a>
            <h4>Docker Machine</h4>
            <p>
              Docker is usually running locally or hosted inside the excellent <a href="http://boot2docker.io">boot2docker</a>, 
              or a <a href="http://vagrantup.com">Vagrant</a> instance, 
              as detailed in my <a href="docker_osx_ubuntu.html">Docker with OSX and Ubuntu</a> howto.
              <a href="https://docs.docker.com/machine"/>Docker Machine</a> lets you create a Docker host VM locally and on a cloud provider in one command.            
            </p>
            <a name="what_docker_swarm"></a>
            <h4>Docker Swarm</h4>
            <p>
              <a href="https://docs.docker.com/swarm/">Docker Swarm</a> lets you create a cluster of Docker Machine instances, so that they appear as one instance host.
              This works locally as well as on cloud providers.
            </p>




            <a name="setup"></a>
            <a name="setup_docker"></a>
            <h3>Install</h3>
            
            <h4>Install Docker</h4>            
            <p>For <a href="http://docs.docker.com/installation/mac/">OSX</a> install via the <a href="https://github.com/boot2docker/osx-installer/releases/tag/v1.5.0">Boot2Docker installer</a> which also installs Docker or via <a href="http://brew.sh">Brew</a>:</p>
            <code>brew install docker;</code>
            <code>brew install boot2docker;</code>
            <code>boot2docker init</code>
            
            <p>For <a href="http://docs.docker.com/installation/ubuntulinux/">Ubuntu</a>:</p>
            <code>sudo apt-key adv \<br/>
              --keyserver hkp://keyserver.ubuntu.com:80 \<br/>
              --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9;</code>
            <code>sudo sh -c \<br/>
              "echo deb https://get.docker.io/ubuntu docker main &gt;\<br/>
              /etc/apt/sources.list.d/docker.list";</code>
            <code>sudo apt-get update;</code>
            <code>sudo apt-get install lxc-docker</code>
            <p>
              Test the install:
            </p>
            <code>docker --version</code>
            <p>
              (Read my <a href="docker_osx_ubuntu.html">Docker with OSX and Ubuntu</a> howto for more detailed instructions and alternatives).
            </p>


            <a name="setup_docker_compose"></a>
            <h4>Install Compose</h4>
            <p>
              Either follow the script on the <a href="http://docs.docker.com/compose/install/">Compose Install</a> page.
              At the time of writing it is this:
            </p>
            <code class="wide tiny">curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` &gt; \<br/>
              /usr/local/bin/docker-compose;</code>
            <code>chmod +x /usr/local/bin/docker-compose</code>
            <p>
              Note the script only works in Bash, not in e.g. <a href="http://fish.sh">Fish</a>.
              You can however replace the <em>uname -s</em> parts manually to get it to work.
            </p>
            <p>
              Or use Brew:
            </p>
            <code>brew install docker-compose</code>
            <p>
              I would also suggest installing the 
              <a href="http://docs.docker.com/compose/completion/">command line completion for Compose</a> if using Bash.
              Note the Brew install also installs this by default.
            </p>
            <p>
              Test the install:
            </p>
            <code>docker-compose --version</code>

            <a name="setup_docker_machine"></a>
            <h4>Install Machine</h4>
            <p>
              Machine require a binary download depending on your OS. 
              Please download the <a href="https://github.com/docker/machine/releases">appropriate one</a> from <a href="https://docs.docker.com/machine/#installation">docs.docker.com/machine/#installation</a>.
            </p>
            <p>
              For OSX :
            </p>
            <code class="wide tiny">wget https://github.com/docker/machine/releases/download/<em>v0.2.0</em>/docker-machine_<em>darwin-amd64</em>;</code>
            <code>chmod +x docker-machine_<em>darwin-amd64</em>;</code>
            <code>mv docker-machine_<em>darwin-amd64</em> /usr/local/bin/docker-machine</code>
            <p>
              Or use Brew:
            </p>
            <code>brew install docker-machine</code>
            <p>
              Test the install:
            </p>
            <code>docker-machine --version</code>

            <a name="setup_virtualbox"></a>
            <h4>Install Virtualbox</h4>
            <p>
              We will also use Virtualbox to create VMs locally with Machine.
            </p>
            <p>
              Either download and install it via the <a href="https://www.virtualbox.org/wiki/Downloads">Virtualbox installers</a>.
            </p>
            <p>
              Or in OSX use Brew with <a href="http://caskroom.io">Cask</a>:
            </p>
            <code>brew cask install virtualbox;</code>
            <p>
              Or via apt-get in Ubuntu:
            </p>
            <code>sudo apt-get install virtualbox</code>


            <a name="local_machine"></a>
            <h4>Local Machine</h4>
            <p>
              Lets create a local VM host with Machine.
            </p>
            <code>
              docker-machine create --driver virtualbox \ <br/>
              --virtualbox-memory 3076 dev;
              </code>
            <p>
              This will download boot2docker as a local VM.
              and allocate 3GB as memory.
              And suggest you update your default settings,
              basically replacing the original boot2docker settings,
              and add these to your .bash_profile or config.fish.
              (<a href="http://github.com/flurdy/dotfiles/blob/master/.bash_profile">my dotfile</a>)
            </p>
            <p>
              Set the environment properties for which machine's docker daemon to communicate with.
              If you use Bash:
            </p>
            <code>$(docker-machine env dev)</code>
            <p>
              Of alternatively if you use <a href="http://fishshell.com">Fish shell</a>:
            </p>
            <code>eval (docker-machine env dev)</code>
            <p>
              Lets list current running machines, ie only the dev one.
            </p>
            <code>docker-machine ls</code>
            <code class="output">
              NAME   ACTIVE   DRIVER &nbsp;&nbsp;&nbsp;   STATE   &nbsp;  URL   
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SWARM<br/>
              dev &nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virtualbox   Running   tcp://192.168.99.100:2376
             </code>   



            <a name="setup_docker_swarm"></a>
            <h4>Install Swarm</h4>
            <p>
              Swarm is available as a Docker image so to install is simply:
            </p>
            <code>docker pull swarm</code>
            <p>
              Or use Brew:
            </p>
            <code>brew install docker-swarm</code>


            <a name="orchestrate"></a>
            <h3>Orchestrate</h3>
            <p>
              Lets create a common basic 3 system architecture.
              One database based on <a href="http://postgresql.org">Postgres</a>.
              One API service application based on <a href="http://spray.io">Spray</a>.
              One simple frontend application based on <a href="http://www.playframework.com">Play</a>.
            </p>
            <p>
              The frontend talks to the API and the API talks to the database.
            </p>
            <p>
              My preference for all things <a href="http://scala-lang.org">Scala</a> is obvious, you might want to pull in other tech stacks instead. 
            </p>
            <p>
              Clone my <a href="http://github.com/flurdy/docker-compose-machine-swarm-cloud-example">example code</a> or you can install a <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java JDK</a> 
              and <a href="http://typesafe.com/get-started">Typesafe's Activator</a>
               to manually create the project.
               The example code use Java and Activator inside Docker images so you don't need to install them.
            </p>
            <code>
               git clone https://github.com/flurdy/docker-compose-machine-swarm-cloud-example.git
            </code>

            <p>
              Though the building process later would download them, 
              you might as well pre download the following Docker images that this project uses.
            </p>
            <code>docker pull debian:wheezy;</code>
            <code>docker pull postgres:9.4;</code>
            <code>docker pull flurdy/activator:1.3.2</code>

            <p>
              The <em>frontend</em> application has a <em>Dockerfile</em> that describe it like this:
            </p>
            <code>vi frontend/Dockerfile</code>
            <code class="file wide">
              FROM flurdy/activator:1.3.2<br/>
              <br/>
              MAINTAINER flurdy<br/>
              <br/>
              ENV DEBIAN_FRONTEND noninteractive<br/>
              <br/>
              ENV APPDIR /opt/app<br/>
              <br/>
              RUN mkdir -p /etc/opt/app &amp;&amp; \<br/>
				  &nbsp;&nbsp;mkdir -p $HOME/.sbt/0.13<br/>
              <br/>
              ADD . /opt/app<br/>
              <br/>
              WORKDIR /opt/app<br/>
              <br/>
              RUN rm -rf /opt/app/target /opt/app/project/project /opt/app/project/target<br/>
              <br/>
              RUN cp /opt/app/conf/* /etc/opt/app/ &amp;&amp; \<br/>
              &nbsp;&nbsp;cp /opt/app/conf/repositories $HOME/.sbt/ &amp;&amp; \<br/>
              &nbsp;&nbsp;cp /opt/app/conf/local.sbt $HOME/.sbt./0.13/<br/>
              <br/>
              RUN /usr/local/bin/activator stage<br/>
              <br/>
              WORKDIR /opt/app<br/>
              <br/>
              ENTRYPOINT /opt/app/target/universal/stage/bin/frontend<br/>
              <br/>
              CMD "-Dconfig.file=/etc/opt/app/docker.conf"<br/>
              <br/>
              EXPOSE 9000<br/>
              EXPOSE 9999
            </code>
            <p>
              This pulls in an <a href="https://registry.hub.docker.com/u/flurdy/activator/">Activator Docker image I have</a> on <a href="https://registry.hub.docker.com/">Dockerhub</a>.
              It adds a <em>repository</em> file to use local maven and ivy repositories to avoid 
              constantly downloading the internet on each build.
            </p>

            <p>
              The <em>service</em> application has a <em>Dockerfile</em> that describe it like this:
            </p>
            <code>vi service/Dockerfile</code>
            <code class="file">
              FROM flurdy/activator:1.3.2<br/>
              <br/>
              MAINTAINER flurdy<br/>
              <br/>
              ENV DEBIAN_FRONTEND noninteractive<br/>
              <br/>
              ENV APPDIR /opt/app<br/>
              <br/>
              RUN mkdir -p /etc/opt/app &amp;&amp; \<br/>
				  &nbsp;&nbsp;mkdir -p $HOME/.sbt/0.13<br/>
              <br/>
              ADD . /opt/app<br/>
              <br/>
              WORKDIR /opt/app<br/>
              <br/>
              RUN rm -rf /opt/app/target /opt/app/project/project /opt/app/project/target<br/>
              <br/>
              RUN cp /opt/app/src/main/resources/* /etc/opt/app/ &amp;&amp; \<br/>
              &nbsp;&nbsp;cp /opt/app/src/main/resources/repositories $HOME/.sbt/ &amp;&amp; \<br/>
              &nbsp;&nbsp;cp /opt/app/src/main/resources/local.sbt $HOME/.sbt./0.13/ &amp;&amp; \<br/>
              &nbsp;&nbsp;chmod +x /opt/app/src/main/resources/start.sh<br/>
              <br/>
				  RUN /usr/local/bin/activator assembly<br/>
              <br/>
              ENTRYPOINT ["/opt/app/src/main/resources/start.sh"]<br/>
              <br/>
				  CMD "-config.file=/etc/opt/app/docker.conf"<br/>
				  <br/>
              EXPOSE 8880
            </code>

            <p>
              The <em>docker-compose.yml</em> is what defines the orchestration for this system.
            </p>
            <code>vi docker-compose.yml;</code>
            <code class="file">
              frontend: 
              <div class="indent1">   
                 build: frontend <br/>
                 entrypoint: /opt/app/target/universal/stage/bin/frontend <br/>
                 command: "-Dconfig.file=/etc/opt/frontend/docker.conf" <br/>
                 links: 
                  <div class="indent1">   
                    - "service" 
                 </div>
                 ports: 
                 <div class="indent1">   
                    - "49910:9000" 
                 </div>
                 # volumes: 
                 <div class="indent1">   
                    # - frontend/conf:/etc/opt/frontend:ro
                 </div>
                 volumes_from: 
                 <div class="indent1">   
                    - maven
                  </div>
              </div>
              service: 
              <div class="indent1">   
                 build: service <br/>
                 command: run -Dconfig.file=/etc/opt/service/docker.conf <br/>
                 links: 
                 <div class="indent1">   
                    - "database" 
                 </div>
                 ports:
                 <div class="indent1">   
                    - "49920:8880" 
                 </div>
                 expose: 
                 <div class="indent1">   
                    - "8880" 
                 </div>
                 # volumes: 
                 <div class="indent1">   
						  # - service/src/main/resources:/etc/opt/service:ro 
                 </div> 
                 volumes_from: 
                 <div class="indent1">   
                    - maven 
                 </div>
              </div>
              database: 
              <div class="indent1">   
                 image: postgres:9.4 <br/>
                 expose:
                 <div class="indent1">   
                    - "5432" 
                 </div>
              </div>
              maven:
              <div class="indent1">   
                 image: debian:wheezy <br/>
                 volumes: 
                 <div class="indent1">   
                    - ~/.m2:/root/.m2: <br/>
                    - ~/.ivy2:/root/.ivy2:rw <br/>
                    - ~/.m2:/home/docker/.ivy2:rw <br/>
                    - ~/.ivy2:/home/docker/.ivy2:rw <br/>
                    - services/src/main/resources:/root/.sbt:ro
                 </div>
              </div>
            </code>
            <p>
              It adds a database image, and also a maven image to <a href="http://blog.flurdy.com/2014/11/dont-download-internet-share-maven-ivy-docker.html">cache maven and ivy downloads</a>. 
              The maven image does not even have to be running for the volumes to work with 
              other containers.
            </p>
            <p>
              To speed up maven, ivy and sbt log into your local machine VM and create symlinks to your host folders. 
              The boot2docker image does auto mount your <em>/Users</em> or <em>/Home</em> folders which is handy.
            </p>
            <code>docker-machine ssh;</code>
            <code>ln -s /<em>Users/myuser/</em>.m2 ~/.m2;</code>
            <code>ln -s /<em>Users/myuser/</em>.ivy2 ~/.ivy2;</code>
            <code>exit</code>

            <p>
              Now lets build and run these. These steps are where you will spend a lot of time getting right....
            </p>
            <code>docker-compose build</code>
            <p>
              If this builds ok we can can launch the orchestration as a daemon.
            </p>
            <code>docker-compose up -d</code>
            <p>
              And check if it is running.
            </p>
            <code>docker-compose ps</code>
            <p>
              If you have problems, then logs are available.
            </p>
            <code>docker-compose logs</code>
            <p>
              Some quick curl calls to see if it works ok.
              Lets post a pizza order, and see if it is listed in the database afterwards.
            </p>
            <code>
              curl -H 'Content-Type: application/json' \<br/>
               -d '{"pizza": "Pepperoni"}' 
               "http://<em>$(docker-machine ip)</em>:49920/pizza";</code>
            <code>curl "http://<em>$(docker-machine ip)</em>:49920/pizzas"</code>
            <p>
              Hopefull the response is something like this:
            </p>
            <code class="output">
              {
              <div class="indent1">
                "pizzas": [{
                <div class="indent1">
                  "id": 1, <br/>
                  "pizza": "pepperoni"
                </div>
                }]
              </div>
              }
            </code>
            <p>
              You can also see the pizza orders listed via the frontend.
            </p>
            <code>
              open <a href="http://192.168.99.100:49910">http://<em>192.168.99.100</em>:49910</a>
            </code>
            <p>
              (TODO: Make a more lightweight example...)
            </p>



            <a name="generate_cloud"></a>
            <h3>Create clouds</h3>
            <p>
              As you created a Machine locally,
              you can easily create Machine(s) in a cloud/IAAS provider.
              Or your own hosting solutions.
            </p>
            <a name="cloud_google"></a>
            <h4>Google Compute Engine</h4>
            <p>
              Our first provider is <a href="https://cloud.google.com/compute/">Google Compute Engine</a>.
              Create an account if you have not already done so.
              Configure billing or take advantage of their generous two month trial to experiment with.
            </p>
            <p>
              Go to the <a href="https://console.developers.google.com/">Google Developers Console</a> and create a project. Take note of the generated project id, not the project name.
            </p>
            <p>
              You also need to go into the <em>APIs &amp; auth</em>'s APIs settings 
              and turn on the <em>Google Compute Engine</em> API.
            </p>
            <p>
              Google will launch a browser window for OAuth authentication,
              so make sure you are on a non headless environment.
              It will provide a token for you to copy-paste into the shell.
            </p>
            <p>
              Note Google Compute Engine with Machine requires a Docker Engine build
              that includes <a href="https://github.com/docker/docker/pull/8265">identity support</a>.
            </p>
            <code>
              docker-machine create \<br/>
              --driver google \<br/>
              --google-project <em>your-project-name</em> \<br/>
              --google-zone <em>europe-west1-c</em> \<br/>
              <em>gcebox</em>
            </code>


            <a name="cloud_aws"></a>
            <h4>Amazon AWS</h4>
            <p>
              As always, create an account with <a href="https://aws.amazon.com/ec2/">Amazon AWS EC2</a> if you do not already have one,
              and log into to the <a href="https://console.aws.amazon.com">AWS console</a>.
              AWS also give you a generous trial to experiment with.
            </p>
            <p>
              I recommend a <a href="http://docs.aws.amazon.com/general/latest/gr/aws-access-keys-best-practices.html">separate IAM credentials</a> to use for this
              as these keys will be exposed in your shell history.
              Depending on your security settings,
              you may need to add the IAM user to an IAM group as well.
            </p>
            <p>
              Create a normal VPC, noting the VPC id, the region and zone you created it in.
              You will also need to find what the public subnet id that the vpc is in.
            </p>
            <code>
              docker-machine create \<br/>
              --driver amazonec2 \<br/>
              --amazonec2-access-key <em>your-aws-access-key</em> \<br/>
              --amazonec2-secret-key <em>your-aws-secret-key</em> \<br/>
              --amazonec2-vpc-id <em>your-aws-vpc-id</em> \<br/>
              --amazonec2-subnet-id <em>your-aws-subnet-id</em> \<br/>
              --amazonec2-region <em>us-east-1</em> \<br/>
              --amazonec2-zone <em>a</em> \<br/>
              <em>ec2box</em>
            </code>

            <p>
              You will need to log onto the EC2 console and edit the security group called <em>Docker+Machine</em>.
              And add the tcp port range <em>49900-49999</em> for your ip.
            </p>


            <a name="cloud_digitalocean"></a>
            <h4>Digital Ocean</h4>
            <p>
              As with the others first create an account with <a href="http://www.digitalocean.com">Digital Ocean</a>.
              Then create a personal API token in DO's admin panel.
            </p>
            <code>
              docker-machine create \<br/>
              --driver digitalocean \<br/>
              --digitalocean-access-token <em>your-digitalocean-api-token</em> \<br/>
				  --digitalocean-size <em>2gb</em> \<br/>
              <em>dobox</em>
            </code>
            <p>


            <a name="cloud_other"></a>
            <h4>Other providers</h4>
            <p>
              Machine and Swarm do support a range of <a href="https://docs.docker.com/machine/#drivers">other providers</a>.
              If anyone want to send <a href="https://github.com/flurdy/flurdy.com-docs">Pull Requests</a> with examples, then please do.
            </p>


            <a name="cloud_stop"></a>
            <h4>Stop and remove cloud machines</h4>
            <p>
              If you want stop machines, 
              especially expensive cloud based instances:
            </p>
            <code>docker-machine stop <em>ec2box</em></code>
            <p>
              Note if you stop and start remote cloud machines,
              you may end up with different IPs and 
              then that cloud machine's certificate will be recreated automatically (since Machine 0.2). 
            </p>
            <p>
              If you want remove machines.
            </p>
            <code>docker-machine rm <em>ec2box</em></code>
            <p>
              If you want remove broken machines.
            </p>
            <code>docker-machine rm -f <em>ec2box</em></code>
            


            <a name="push_cloud"></a>
            <h3>Push to the cloud</h3>
            <p>
              You will now have your local dev machine
              and one or more cloud based instances.
            </p>
            <code>docker-machine ls</code>
            <code class="output">
              NAME   &nbsp;ACTIVE   DRIVER &nbsp;&nbsp;&nbsp;   &nbsp;STATE   &nbsp;  URL   
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SWARM<br/>
              dev &nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;virtualbox&nbsp;&nbsp;   Running   tcp://192.168.99.100:2376<br/>
              ec2box&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;amazonec2&nbsp;&nbsp;&nbsp;   Running   tcp://<em>1.2.3.4:2376</em><br/>
              gcebox&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;google&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Stopped<br/>
              dobox&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digitalocean&nbsp;Stopped   
             </code>  
             <p>
               Lets make the ec2 box active, which would be the box any docker or compose commands talk to.
             </p>
             <code>docker-machine active ec2box;</code>
            <code>docker-machine ls</code>
            <code class="output">
              NAME   &nbsp;ACTIVE   DRIVER &nbsp;&nbsp;&nbsp;   &nbsp;STATE   &nbsp;  URL   
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SWARM<br/>
              dev &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virtualbox&nbsp;&nbsp;   Running   tcp://192.168.99.100:2376<br/>
              ec2box&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;amazonec2&nbsp;&nbsp;&nbsp;   Running   tcp://<em>1.2.3.4:2376</em><br/>
              gcebox&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;google&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Stopped<br/>
              dobox&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digitalocean&nbsp;Stopped   
            </code> 

            <p>
              Point Docker to the cloud machine.
            </p>
            <code>$(docker-machine env ec2box);</code>
            <code>docker info</code>
            <p>
              And run our orchestration on the cloud machine.
            </p>
            <code>docker-compose up -d;</code>
            <code>docker-compose logs;</code>
            <code>export DOCKER_IP=$(docker-machine ip);</code>
            <code>curl "http://$DOCKER_IP:49910"  </code>


            <a name="scale_cloud"></a>
            <h3>Scale the cloud</h3>
            <p>
              We have created just one machine instance for Docker in a cloud provider(s).
              If you plan to keep adding orchestrations to it
              or want to scale more horizontally for capacity and reliability
              then you need more instances.
              And as mentioned Swarm handles this and still exposes it as just one instance.
            </p>

            <h4>Compose &amp; Swarm Issues</h4>
            <p>
              Currently there are <a href="https://github.com/docker/compose/blob/master/SWARM.md">some significant issues</a> with using Compose with Swarm.
              These will be <a href="https://github.com/docker/docker/issues/9983">resolved</a> very soon
              and there are <a href="https://github.com/docker/swarm/blob/master/scheduler/filter/README.md#affinity-filter">some workarounds</a> for now.
              So currently if using Swarm you may want to run normal Docker containers directly and not with Compose.
            </p>

            
            <a name="swarm_local"></a>
            <h4>Swarm locally</h4>
            <p>
              Lets scale up locally first.
            </p>
            <code>docker-machine active dev;</code>
            <code>$(docker-machine env dev);</code>
            <code>docker run swarm create</code>
            <p>
              Which should respond with a token to use when creating a swarm master and nodes.
            </p>
            <code class="output">abcd098765</code>
            <p>
              Then create a swarm master node.
            </p>
            <code>
              docker-machine create \<br/>
              -d virtualbox \<br/>
              --swarm \<br/>
              --swarm-master \<br/>
              --swarm-discovery token://<em>abcd09876</em> \<br/>
              <em>swarm-master</em>
            </code>
            <p>
              And create a few swarm nodes
            </p>
            <code>
              docker-machine create \<br/>
              -d virtualbox \<br/>
              --swarm \<br/>
              --swarm-discovery token://<em>abcd09876</em> \<br/>
              <em>swarm-node-00</em>;
            </code>
            <code>
              docker-machine create \<br/>
              -d virtualbox \<br/>
              --swarm \<br/>
              --swarm-discovery token://<em>abcd09876</em> \<br/>
              <em>swarm-node-01</em>
            </code>
            <p>
              And a simple check to see if it is running:
            </p>
            <code>$(docker-machine env --swarm swarm-master);</code>
            <code>docker info</code>

            <!--  
            <p>
              Quick check to see if Compose works with the new swarms.
            </p>
            <code>docker-compose up -d;</code>
            <code>docker-compose logs</code>
            -->

            <a name="swarm_cloud"></a>
            <h4>Swarm in the cloud</h4>
            <p>
              Swarming in the cloud is just about changing the driver,
              and all the extra driver options. 
            </p>
            <code>docker-machine active ec2box;</code>
            <code>$(docker-machine env ec2box);</code>
            <code>docker run swarm create</code>
            <code class="output">12321312</code>
            <code>
              docker-machine create \<br/>
              -d amazonec2 \<br/>
              --amazonec2-access-key <em>your-aws-access-key</em> \<br/>
              --amazonec2-secret-key <em>your-aws-secret-key</em> \<br/>
              --amazonec2-vpc-id <em>your-aws-vpc-id</em> \<br/>
              --amazonec2-subnet-id <em>your-aws-subnet-id</em> \<br/>
              --amazonec2-region <em>us-east-1</em> \<br/>
              --amazonec2-zone <em>a</em> \<br/>
              --swarm \<br/>
              --swarm-master \<br/>
              --swarm-discovery token://<em>12321312</em> \<br/>
              <em>swarm-ec2-master;</em>
            </code>
            <code>
              docker-machine create \<br/>
              -d amazonec2 \<br/>
              --amazonec2-access-key <em>your-aws-access-key</em> \<br/>
              --amazonec2-secret-key <em>your-aws-secret-key</em> \<br/>
              --amazonec2-vpc-id <em>your-aws-vpc-id</em> \<br/>
              --amazonec2-subnet-id <em>your-aws-subnet-id</em> \<br/>
              --amazonec2-region <em>us-east-1</em> \<br/>
              --amazonec2-zone <em>a</em> \<br/>
              --swarm \<br/>
              --swarm-discovery token://<em>12321312</em> \<br/>
              <em>swarm-ec2-node-00</em>;
            </code>
            <code>
              docker-machine create \<br/>
              -d amazonec2 \<br/>
              --amazonec2-access-key <em>your-aws-access-key</em> \<br/>
              --amazonec2-secret-key <em>your-aws-secret-key</em> \<br/>
              --amazonec2-vpc-id <em>your-aws-vpc-id</em> \<br/>
              --amazonec2-subnet-id <em>your-aws-subnet-id</em> \<br/>
              --amazonec2-region <em>us-east-1</em> \<br/>
              --amazonec2-zone <em>a</em> \<br/>
              --swarm \<br/>
              --swarm-discovery token://<em>12321312</em> \<br/>
              <em>swarm-ec2-node-01;</em>
            </code>
            <code>$(docker-machine env --swarm swarm-ec2-master);</code>
            <code>docker info</code>



            <a name="summary"></a>
            <h3>Summary</h3>
            <p>
              You can now orchestrate applications, 
              create machines locally and in several cloud providers
              and scale this across multiple instances.
            </p>
            <p>
              You are now free to automate and extend this progress, 
              add other tools such as <a href="https://github.com/progrium/dokku">Dokku</a> etc.
            </p>

            <a name="future"></a>
            <h3>Future</h3>
            <p>
              The Machine and Swarm integration with Compose will get better.
            </p>
            <p>
              A lot of tools will be created on top of these or added to existing toolsets.
            </p>
            <p>
              A credentials registry to share between teams for multiple providers would be handy.
            </p>
            <p>
              I am tempted to create a script that lets you promote a local swarm to another provider in one simple command.
              This will let you quickly scale up/clone new environments and across providers at ease.
            </p>

            <a name="alternative"></a>
            <h3>Alternatives</h3>
            <p>
              You can instead use the Docker specific container services
              such as AWS's closed beta <a href="https://aws.amazon.com/ecs/">Container Service</a> 
              or Google's open beta <a href="https://cloud.google.com/container-engine/">Container Engine</a>. 
              You can use Google's <a href="http://kubernetes.io">Kubernetes</a> for a higher level cluster management.
              Joyent's <a href="https://www.joyent.com/developers/triton-faq">Triton Container Service</a> across a whole data centre sounds awesome.
            </p>


            <a name="reference"></a>
            <h3>References</h3>
            <p>
              This howto was heavily influenced by Docker's own documentation and presentations. In time it will mix with other sources and extend with my own experiences.
            </p>
            <ul>
               <li><a href="https://www.docker.com">Docker</a></li>
               <li><a href="https://docs.docker.com/swarm/">Docker Swarm</a></li>
               <li><a href="https://docs.docker.com/machine/">Docker Machine</a></li>
               <li><a href="https://docs.docker.com/compose/">Docker Compose</a></li>
               <li><a href="http://fig.sh">Fig</a></li>
               <li><a href="http://blog.docker.com/2015/02/announcing-docker-compose/">Announcing Docker Compose</a></li>
               <li><a href="https://blog.docker.com/2015/02/announcing-docker-machine-beta/">Announcing Docker Machine</a></li>
               <li><a href="http://blog.docker.com/2015/01/dockercon-eu-introducing-docker-swarm/">Introducing Docker Swarm</a></li>
               <li><a href="http://blog.docker.com/2015/02/scaling-docker-with-swarm/">Scaling Docker with Swarm</a></li>
               <li><a href="http://blog.docker.com/2015/02/orchestrating-docker-with-machine-swarm-and-compose/">Orchestrating Docker with Machine Swarm and Compose</a></li>
               <li><a href="https://cloud.google.com/compute/">Google Compute Engine</a></li>
               <li><a href="https://cloud.google.com/container-engine/">Google Container Engine</a></li>
               <li><a href="https://aws.amazon.com/ec2/">AWS EC2</a></li>
               <li><a href="https://aws.amazon.com/ecs/">AWS Container Service</a></li>
               <li><a href="http://www.digitalocean.com">Digital Ocean</a></li>
               <li><a href="http://kubernetes.io/">Kubernetes</a></li>
               <li><a href="https://github.com/coreos/rocket">CoreOS Rocket</a></li>
               <li><a href="https://github.com/boot2docker/boot2docker">Boot2docker</a></li>
               <li><a href="http://vagrantup.com">Vagrant</a></li>
               <li><a href="docker_osx_ubuntu.html">Docker with OSX and Ubuntu</a></li>
               <li><a href="http://blog.flurdy.com/2014/11/dockerise-it-all-containerised-addiction.html">Dockerise it all - containerised addiction <br/>= CDD - Container Driven Development</a></li>
               <li><a href="https://github.com/progrium/dokku">Dokku</a></li>
               <li><a href="http://panamax.io/">Panamax</a></li>
               <li><a href="http://shipyard-project.com/">Shipyard</a></li>
               <li><a href="https://www.joyent.com/developers/triton-faq">Joyent Triton Elastic Container Service</a></li>
               <li><a href="https://github.com/docker/libnetwork">Docker libnetwork</a></li>
               <li><a href="http://weave.works">Weave works</a></li>
               <li><a href="https://github.com/flurdy/docker-compose-machine-swarm-cloud-example">github.com/flurdy/docker-compose-machine-swarm-cloud-example</a></li>
               <!--
               <li><a href=""></a></li>
               -->
            </ul>


            <a name="contact"></a>
            <h3>Feedback</h3>
            <p>
               Please <a href="http://github.com/flurdy/flurdy.com-docs">fork and send a pull request</a> for to correct any typos, or useful additions.
            </p>
            <p>
               <a href="http://shirts.flurdy.com">Buy a t-shirt</a> if you found this guide useful.
               <a href="http://www.eray.uk">Hire Ivar</a> for short term advice or long term consultancy.
            </p>
            <p>
               Otherwise <a href="/contact">contact flurdy</a>.
               Especially for things factually incorrect.
               Apologies for procrastinated replies.
            </p>

      </div>
         <footer>
            <nav>
               <ul class="horizontal">
                  <li><a href="http://flurdy.com">flurdy</a></li>
                  <li><a href="http://twitter.com/flurdy">@flurdy</a></li>
                  <li><a href="http://blog.flurdy.com">blog</a></li>
                  <li><a href="http://shirts.flurdy.com">shirts</a></li>
                  <li><a href="http://www.eray.uk">hire</a></li>
                  <li><a href="/docs/">more docs</a></li>
               </ul>
            </nav>
         </footer>
      </div>
   </div>


   <link href='http://fonts.googleapis.com/css?family=Michroma' rel='stylesheet' type='text/css' />
</body>
</html>
